---
---

<div id="chatbot">
  <!-- Floating chat button -->
  <button
    id="chat-toggle"
    class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-brand-green text-black rounded-full shadow-lg hover:bg-green-400 transition-colors duration-200 flex items-center justify-center"
    aria-label="√Öpne chat"
  >
    <svg id="chat-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
    </svg>
    <svg id="chat-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- Chat panel -->
  <div
    id="chat-panel"
    class="fixed bottom-24 right-6 z-50 w-[360px] max-sm:bottom-0 max-sm:right-0 max-sm:w-full max-sm:h-full bg-brand-gray border border-white/10 rounded-2xl max-sm:rounded-none shadow-2xl flex-col overflow-hidden hidden"
    role="dialog"
    aria-label="Chat med Parken Treningssenter"
  >
    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-3 bg-brand-dark border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-brand-green rounded-full flex items-center justify-center">
          <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        </div>
        <div>
          <p class="font-semibold text-sm text-white">Parken Treningssenter</p>
          <p class="text-xs text-gray-400">Sp√∏r oss om hva som helst</p>
        </div>
      </div>
      <button
        id="chat-close"
        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/10 transition-colors text-gray-400 hover:text-white"
        aria-label="Lukk chat"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3" style="height: calc(100% - 130px); min-height: 300px;">
    </div>

    <!-- Input -->
    <div class="border-t border-white/10 p-3">
      <form id="chat-form" class="flex gap-2">
        <label for="chat-input" class="sr-only">Skriv en melding</label>
        <input
          id="chat-input"
          type="text"
          placeholder="Skriv en melding..."
          autocomplete="off"
          class="flex-1 bg-brand-dark border border-white/10 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-brand-green transition-colors"
        />
        <button
          type="submit"
          class="w-10 h-10 bg-brand-green text-black rounded-lg flex items-center justify-center hover:bg-green-400 transition-colors flex-shrink-0"
          aria-label="Send melding"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7" />
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const knowledgeBase = [
    {
      keywords: ["melde inn", "innmelding", "registrere", "bli medlem", "signup", "meld meg inn", "meld inn", "medlem", "starte"],
      answer: 'Du melder deg inn via v√•r nettside. Registreringen er rask og enkel ‚Äî ingen bindingstid! Ved innmelding betaler du for resterende innev√¶rende m√•ned pluss neste m√•ned (forskuddsbetaling).\n\n<a href="https://parkentrening.ibooking.no/nettinnmelding" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline">Meld deg inn her &rarr;</a>',
    },
    {
      keywords: ["si opp", "oppsigelse", "avslutte", "kansellere", "avslut", "slutte", "stoppe", "oppsigelsestid"],
      answer: 'Du sier opp medlemskapet direkte i Membro-appen. Oppsigelsestiden er 1 m√•ned gjeldende fra den 1. i p√•f√∏lgende m√•ned. Last ned appen, logg inn, og f√∏lg instruksjonene.\n\n<a href="https://apps.apple.com/no/app/membro/id1542602956" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline app-store-link">App Store</a> ¬∑ <a href="https://play.google.com/store/apps/details?id=no.ibooking.membroapp&amp;hl=en" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline google-play-link">Google Play</a>',
    },
    {
      keywords: ["binding", "bindingstid", "kontrakt", "avtale", "binde", "forplikte"],
      answer: "Nei, det er ingen bindingstid hos oss! Du kan melde deg inn og si opp n√•r som helst, helt uten forpliktelser.",
    },
    {
      keywords: ["√•pningstid", "√•pent", "stengt", "timer", "24", "d√∏gn√•pent", "tid", "√•pne", "lukke", "lukket", "n√•r"],
      answer: "Vi har d√∏gn√•pent! Parken Treningssenter er √•pent 24 timer i d√∏gnet, 7 dager i uken. Du kan trene akkurat n√•r det passer deg. üí™",
    },
    {
      keywords: ["pris", "kost", "betale", "billig", "kr", "hva koster", "dyr", "bel√∏p", "avgift", "m√•nedlig"],
      answer: 'Vi er kjent for √• ha lave priser. For oppdaterte priser og medlemskap, se v√•r innmeldingsside.\n\n<a href="https://parkentrening.ibooking.no/nettinnmelding" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline">Se priser &rarr;</a>',
    },
    {
      keywords: ["personlig trener", "pt", "veiledning", "trener", "trenerhjelp", "treningsr√•d", "program"],
      answer: "Ja, vi har dyktige og erfarne personlige trenere til disposisjon, med bred erfaring og h√∏yere utdanning innen helsefag. Ikke n√∏l med √• ta kontakt!",
    },
    {
      keywords: ["membro", "app", "appen", "applikasjon", "applikasjonen", "d√∏r√•pning", "d√∏r"],
      answer: 'Membro er appen vi bruker for administrasjon av medlemskap. Her kan du administrere kontoen din, se betalingsinformasjon og si opp medlemskapet. I tillegg gir appen deg tilgang til senteret med mobil d√∏r√•pning rett fra telefonen.\n\n<a href="https://apps.apple.com/no/app/membro/id1542602956" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline app-store-link">App Store</a> ¬∑ <a href="https://play.google.com/store/apps/details?id=no.ibooking.membroapp&amp;hl=en" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline google-play-link">Google Play</a>',
    },
    {
      keywords: ["adresse", "hvor", "finne", "kart", "lokasjon", "beliggenhet", "veibeskrivelse", "ligger"],
      answer: 'Vi holder til i Torvhusmyrane 18, 5913 Eikanger.\n\n<a href="https://maps.google.com/?q=Torvhusmyrane+18,+5913+Eikanger" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline">Vis i Google Maps &rarr;</a>',
    },
    {
      keywords: ["kontakt", "epost", "mail", "e-post", "n√• dere", "snakke med"],
      answer: 'Du kan kontakte oss p√•:\n\nEpost: parkentreningssenter@outlook.com\n\nDu finner oss ogs√• p√• <a href="https://www.facebook.com/profile.php?id=100063629467247" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline">Facebook</a> og <a href="https://www.instagram.com/parkentreningssenter/" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline">Instagram</a>.',
    },
    {
      keywords: ["utstyr", "apparater", "maskiner", "vekter", "treningsapparater", "fasiliteter", "tilbud"],
      answer: 'Vi har et bredt utvalg av treningsutstyr inkludert frivekter, maskiner og kardioutstyr. Sjekk ut v√•r <a href="#facilities" class="text-brand-green hover:underline">fasilitetsseksjon</a> for mer info!',
    },
    {
      keywords: ["pr√∏ve", "pr√∏vetime", "teste", "test", "gratis trening", "pr√∏veperiode"],
      answer: "Vi tilbyr dessverre ikke pr√∏vetimer. Men med ingen bindingstid kan du melde deg inn og pr√∏ve oss helt uforpliktende!",
    },
    {
      keywords: ["fryse", "frys", "pause", "pausere", "stoppe midlertidig"],
      answer: "Vi tilbyr ikke frysing av medlemskap. Dersom du √∏nsker en pause, kan du si opp og melde deg inn igjen n√•r du er klar for √• trene. Det er ingen bindingstid!",
    },
    {
      keywords: ["forskudd", "betaling", "f√∏rste betaling", "hva betaler jeg"],
      answer: 'Ved innmelding betaler du for resterende innev√¶rende m√•ned pluss neste m√•ned (forskuddsbetaling). For oppdaterte priser, se v√•r <a href="https://parkentrening.ibooking.no/nettinnmelding" target="_blank" rel="noopener noreferrer" class="text-brand-green hover:underline">innmeldingsside</a>.',
    },
  ];

  const fallbackAnswer = 'Beklager, jeg fant ikke et svar p√• det. Du kan sjekke v√•r <a href="#faq" class="text-brand-green hover:underline">FAQ-seksjon</a> eller kontakte oss p√• parkentreningssenter@outlook.com for mer hjelp.';

  const quickReplies = [
    { label: "Bli medlem", query: "bli medlem" },
    { label: "Si opp", query: "si opp" },
    { label: "√Öpningstider", query: "√•pningstider" },
    { label: "Priser", query: "priser" },
  ];

  const toggleBtn = document.getElementById("chat-toggle")!;
  const panel = document.getElementById("chat-panel")!;
  const closeBtn = document.getElementById("chat-close")!;
  const messagesEl = document.getElementById("chat-messages")!;
  const form = document.getElementById("chat-form") as HTMLFormElement;
  const input = document.getElementById("chat-input") as HTMLInputElement;
  const iconOpen = document.getElementById("chat-icon-open")!;
  const iconClose = document.getElementById("chat-icon-close")!;

  let isOpen = false;
  let hasInitialized = false;

  function openChat() {
    isOpen = true;
    panel.classList.remove("hidden");
    panel.classList.add("flex");
    iconOpen.classList.add("hidden");
    iconClose.classList.remove("hidden");
    toggleBtn.setAttribute("aria-label", "Lukk chat");
    input.focus();

    if (!hasInitialized) {
      hasInitialized = true;
      addBotMessage("Hei! üëã Jeg kan hjelpe deg med sp√∏rsm√•l om Parken Treningssenter. Velg et tema eller skriv et sp√∏rsm√•l.");
      addQuickReplies();
    }
  }

  function closeChat() {
    isOpen = false;
    panel.classList.add("hidden");
    panel.classList.remove("flex");
    iconOpen.classList.remove("hidden");
    iconClose.classList.add("hidden");
    toggleBtn.setAttribute("aria-label", "√Öpne chat");
    toggleBtn.focus();
  }

  function toggleChat() {
    if (isOpen) closeChat();
    else openChat();
  }

  function addBotMessage(html: string) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex gap-2 items-start";

    const avatar = document.createElement("div");
    avatar.className = "w-7 h-7 bg-brand-green rounded-full flex items-center justify-center flex-shrink-0 mt-0.5";
    avatar.innerHTML = '<svg class="w-3.5 h-3.5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>';

    const bubble = document.createElement("div");
    bubble.className = "bg-brand-dark border border-white/10 rounded-xl rounded-tl-sm px-3 py-2 text-sm text-gray-200 leading-relaxed max-w-[85%]";
    bubble.innerHTML = html.replace(/\n/g, "<br>");

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
  }

  function addUserMessage(text: string) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex justify-end";

    const bubble = document.createElement("div");
    bubble.className = "bg-brand-green text-black rounded-xl rounded-tr-sm px-3 py-2 text-sm font-medium max-w-[85%]";
    bubble.textContent = text;

    wrapper.appendChild(bubble);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
  }

  function addQuickReplies() {
    const wrapper = document.createElement("div");
    wrapper.className = "flex flex-wrap gap-2 chat-quick-replies";

    quickReplies.forEach((qr) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "px-3 py-1.5 text-xs font-medium border border-brand-green text-brand-green rounded-full hover:bg-brand-green hover:text-black transition-colors";
      btn.textContent = qr.label;
      btn.addEventListener("click", () => {
        handleQuery(qr.query, qr.label);
      });
      wrapper.appendChild(btn);
    });

    messagesEl.appendChild(wrapper);
    scrollToBottom();
  }

  function removeQuickReplies() {
    messagesEl.querySelectorAll(".chat-quick-replies").forEach((el) => el.remove());
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function findAnswer(query: string): string {
    const normalized = query.toLowerCase().trim();

    let bestMatch: { answer: string; score: number } | null = null;

    for (const entry of knowledgeBase) {
      let score = 0;
      for (const keyword of entry.keywords) {
        if (normalized.includes(keyword)) {
          score += keyword.length;
        }
      }
      if (score > 0 && (!bestMatch || score > bestMatch.score)) {
        bestMatch = { answer: entry.answer, score };
      }
    }

    return bestMatch ? bestMatch.answer : fallbackAnswer;
  }

  function handleQuery(query: string, displayText?: string) {
    removeQuickReplies();
    addUserMessage(displayText || query);

    setTimeout(() => {
      const answer = findAnswer(query);
      addBotMessage(answer);
    }, 400);
  }

  toggleBtn.addEventListener("click", toggleChat);
  closeBtn.addEventListener("click", closeChat);

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const query = input.value.trim();
    if (!query) return;
    input.value = "";
    handleQuery(query);
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && isOpen) {
      closeChat();
    }
  });
</script>
